{% extends "base.html" %}

{% block title %}Revisar pago #{{ object.id }} – Junta UT{% endblock %}

{% block content %}
<section class="payments-page">
  <div class="card payment-review-card">
    <h1 class="page-title" style="margin-bottom:.75rem;">
      Revisar pago #{{ object.id }}
    </h1>

    <p style="color:#6b7280; font-size:.9rem; margin-bottom:1rem;">
      Vecino:
      {{ object.resident.get_full_name|default:object.resident.username }}<br>
      Descripción: {{ object.description|default:"(sin descripción)" }}<br>
      Monto: ${{ object.amount|floatformat:0 }}<br>
      {% if object.receipt_file %}
        Comprobante:
        <a href="{{ object.receipt_file.url }}" target="_blank" rel="noopener">
          Ver comprobante
        </a>
      {% else %}
        Comprobante: <span class="text-muted">No adjuntado</span>
      {% endif %}
    </p>

    <form method="post" class="payment-review-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.status.id_for_label }}"
               style="display:block; margin-bottom:.25rem; font-weight:600;">
          {{ form.status.label }}
        </label>
        {{ form.status }}
        {% if form.status.errors %}
          <div style="color:#b91c1c; font-size:.8rem; margin-top:.25rem;">
            {{ form.status.errors }}
          </div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.staff_note.id_for_label }}"
               style="display:block; margin-bottom:.25rem; font-weight:600;">
          {{ form.staff_note.label }}
        </label>
        {{ form.staff_note }}
        {% if form.staff_note.errors %}
          <div style="color:#b91c1c; font-size:.8rem; margin-top:.25rem;">
            {{ form.staff_note.errors }}
          </div>
        {% endif %}
      </div>

      <div style="margin-top:1.25rem; display:flex; gap:.75rem;">
        <button type="submit" class="btn btn-primary btn-small">
          Guardar cambios
        </button>
        <a href="{% url 'core:payment_list_admin' %}"
           class="btn btn-outline btn-small">
          Volver
        </a>
      </div>
    </form>
  </div>
</section>

{# === Estilos del toast (igual que en inscripciones, posición ARRIBA) === #}
<style>
  .insc-toast {
    position: fixed;
    left: 50%;
    top: 18px;
    transform: translateX(-50%) translateY(-20px);
    background: #2052bdff;
    color: #f9fafb;
    padding: 0.6rem 1.4rem;
    border-radius: 999px;
    font-size: 0.85rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
    opacity: 0;
    pointer-events: none;
    z-index: 1300;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  .insc-toast.is-visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
</style>

{# Toast específico de pagos, reutilizando la clase .insc-toast #}
<div id="payment-toast" class="insc-toast"></div>

<script>
  (function () {
    const form        = document.querySelector(".payment-review-form");
    const statusField = document.getElementById("id_status");
    const toastEl     = document.getElementById("payment-toast");

    if (!form || !statusField || !toastEl) return;

    function showToast(message, callback) {
      toastEl.textContent = message;
      toastEl.classList.add("is-visible");

      setTimeout(function () {
        toastEl.classList.remove("is-visible");
        if (typeof callback === "function") {
          callback();
        }
      }, 1100);
    }

    function handleSubmit(e) {
      const value = statusField.value;
      let message = null;

      // Valores del modelo Payment: "paid", "cancelled", etc.
      if (value === "paid") {
        message = "Pago aprobado. Se notificará al vecino por correo.";
      } else if (value === "cancelled") {
        message = "Pago rechazado. Se notificará al vecino para subir un nuevo comprobante.";
      }

      // Si es pendiente / pendiente de revisión → submit normal
      if (!message) {
        return;
      }

      e.preventDefault();

      showToast(message, function () {
        form.removeEventListener("submit", handleSubmit);
        form.submit();
      });
    }

    form.addEventListener("submit", handleSubmit);
  })();
</script>
{% endblock %}
