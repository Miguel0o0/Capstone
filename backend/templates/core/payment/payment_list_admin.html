{% extends "base.html" %}

{% block title %}{{ page_title }} – Junta UT{% endblock %}

{% block content %}
  <section class="payments-page" style="max-width: 1100px; margin: 2.5rem auto 0;">
    <!-- Encabezado -->
    <header class="announcement-page-header">
      <div>
        <h1 class="announcement-page-title">
          {{ page_title }}
        </h1>
        <p class="announcement-page-subtitle">
          Desde aquí la directiva puede revisar los pagos asociados a cuotas y reservas
          realizados por vecinas y vecinos de la comunidad.
        </p>
      </div>

      {% if show_pay_button %}
        <a href="{% url 'core:payment_create_admin' %}" class="btn btn-primary btn-small">
          Realizar pago
        </a>
      {% endif %}
    </header>

    <!-- Filtro por período -->
    <section style="max-width: 520px; margin: 0 auto 1.75rem;">
      <div class="card">
        <form method="get" style="display:flex; flex-direction:column; gap:.75rem;">
          <div>
            <label for="id_period" style="font-size:.85rem; font-weight:600;">
              Período (YYYY-MM)
            </label>
            <input
              id="id_period"
              type="month"
              name="period"
              class="input"
              value="{{ request.GET.period }}"
            >
            <p style="margin:.25rem 0 0; font-size:.8rem; color:var(--color-muted);">
              Si lo indicas, solo se mostrarán los pagos del período seleccionado.
            </p>
          </div>

          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            <button type="submit" class="btn btn-primary btn-small">
              Filtrar
            </button>
            <a href="{% url 'core:payment_list_admin' %}" class="btn btn-outline btn-small">
              Limpiar
            </a>
          </div>
        </form>
      </div>
    </section>

    <!-- Listado de pagos -->
    {% if payments %}
      <div class="payment-admin-list">
        {% for p in payments %}
          <article class="card payment-admin-card">
            <header class="payment-admin-header">
              <div>
                <p class="announcement-meta" style="margin-bottom:.25rem;">
                  {{ p.resident.get_full_name|default:p.resident.username }}
                  {% if p.resident.groups.all %}
                    ·
                    {% for g in p.resident.groups.all %}
                      {% if not forloop.first %}, {% endif %}
                      {{ g.name }}
                    {% endfor %}
                  {% endif %}
                </p>

                <h2 class="payment-card-title" style="margin-bottom:.2rem;">
                  {% if p.origin == 'reservation' and p.reservation %}
                    Pago de reserva:
                    {{ p.reservation.resource.nombre }}
                  {% elif p.fee %}
                    Pago de cuota: {{ p.fee.period }}
                  {% else %}
                    Pago registrado
                  {% endif %}
                </h2>
              </div>

              <div class="payment-admin-amount">
                <span>${{ p.amount|floatformat:0 }}</span>

                {% comment %}
                  Mapear estado del pago a la pill de color:
                  asumimos que los valores del modelo son:
                  'pending', 'pending_review', 'paid', 'cancelled', etc.
                {% endcomment %}
                {% if p.status == 'paid' %}
                  <span class="payment-admin-status payment-admin-status--pagado">
                    Pagado
                  </span>
                {% elif p.status == 'pending' or p.status == 'pending_review' %}
                  <span class="payment-admin-status payment-admin-status--pendiente">
                    Pendiente
                  </span>
                {% elif p.status == 'cancelled' %}
                  <span class="payment-admin-status payment-admin-status--pendiente">
                    Anulado
                  </span>
                {% else %}
                  <span class="payment-admin-status payment-admin-status--pendiente">
                    {{ p.get_status_display }}
                  </span>
                {% endif %}
              </div>
            </header>

            <div class="payment-admin-meta">
              <span>Creado: {{ p.created_at|date:"d/m/Y H:i" }}</span>
              {% if p.paid_at %}
                <span>Pagado: {{ p.paid_at|date:"d/m/Y H:i" }}</span>
              {% endif %}
              {% if p.reservation %}
                <span>Reserva: {{ p.reservation.start_at|date:"d/m/Y H:i" }}</span>
              {% endif %}
            </div>

            <div class="payment-admin-actions">
              {% if p.receipt_file %}
                <a href="{{ p.receipt_file.url }}" target="_blank" class="btn btn-outline btn-small">
                  Ver comprobante
                </a>
              {% else %}
                <span style="font-size:.85rem; color:var(--color-muted);">
                  Sin comprobante cargado
                </span>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="announcement-empty" style="margin-top:1.5rem;">
        No hay pagos registrados para el período seleccionado.
      </p>
    {% endif %}
  </section>
{% endblock %}
