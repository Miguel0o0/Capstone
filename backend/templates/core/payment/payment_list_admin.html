{% extends "base.html" %}
{% load auth_extras %}

{% block title %}Pagos{% endblock %}

{% block content %}
  <h1>Pagos</h1>

  <p>
    {# Tesorero / Admin / Presidente (o quien tenga add_payment) pueden crear pagos manualmente #}
    {% if perms.core.add_payment %}
      <a class="btn btn-primary" href="{% url 'core:payment_create_admin' %}">
        Crear pago
      </a>
    {% endif %}

    {# TODOS los usuarios que entran aquí pueden iniciar el pago de sus deudas #}
    <a class="btn" href="{% url 'core:payment_create' %}">
      Realizar pago
    </a>
  </p>

  <form method="get">
    <label for="period">Periodo: [YYYY-MM]</label>
    <input type="text" name="period" id="period" value="{{ request.GET.period }}">
    <button type="submit">Filtrar</button>
    <a href="{% url 'core:payment_list_admin' %}">Limpiar</a>
  </form>

  <ul>
    {% for p in object_list %}
      <li>
        {# Usuario y rol principal #}
        {% with user_obj=p.resident %}
          {% with first_group=user_obj.groups.first %}
            {{ user_obj.username }}
            {% if first_group %}
              ({{ first_group.name }})
            {% else %}
              (Vecino)
            {% endif %}
          {% endwith %}
        {% endwith %}

        —
        {# Detalle según origen #}
        {% if p.origin == "reservation" and p.reservation %}
          [Reserva] #{{ p.reservation.id }}
          – {{ p.reservation.resource.nombre }}
          ({{ p.reservation.start_at|date:"d/m/Y H:i" }})
        {% elif p.origin == "fee" and p.fee %}
          [Cuota] {{ p.fee.period }}
        {% else %}
          [Pago]
        {% endif %}

        — ${{ p.amount }} — {{ p.get_status_display }}

        {% if p.paid_at %}
          — Pagado {{ p.paid_at|date:"Y-m-d H:i" }}
        {% endif %}

        {# Solo quien tenga permisos de edición ve los botones de edición/borrado #}
        {% if perms.core.change_payment %}
          — <a href="{% url 'core:payment_update_admin' p.pk %}">Editar</a>
        {% endif %}

        {% if perms.core.delete_payment %}
          — <form method="post"
                 action="{% url 'core:payment_delete_admin' p.pk %}"
                 style="display:inline;">
              {% csrf_token %}
              <button type="submit"
                      onclick="return confirm('¿Seguro que deseas borrar este pago?');">
                Borrar
              </button>
            </form>
        {% endif %}
      </li>
    {% empty %}
      <li>No hay pagos registrados para este período.</li>
    {% endfor %}
  </ul>
{% endblock %}
