{% extends "base.html" %}

{% block title %}Inscripciones{% endblock %}

{% block content %}
<div class="container">
  <h1>Inscripciones</h1>

  {# Filtro por estado #}
  <form method="get" class="grid" style="grid-template-columns: auto auto auto; gap:.75rem; max-width:420px; margin:1rem 0;">
    <div>
      <label class="form-label" style="display:block; font-weight:600; margin-bottom:.25rem;">
        Estado
      </label>
      <select name="status" class="select">
        <option value="">Todos</option>
        <option value="PENDING"  {% if request.GET.status == "PENDING" %}selected{% endif %}>Pendiente</option>
        <option value="APPROVED" {% if request.GET.status == "APPROVED" %}selected{% endif %}>Aprobada</option>
        <option value="REJECTED" {% if request.GET.status == "REJECTED" %}selected{% endif %}>Rechazada</option>
      </select>
    </div>
    <div style="display:flex; align-items:flex-end; gap:.5rem;">
      <button class="btn btn-outline" type="submit">Filtrar</button>
      {% if request.GET.status %}
        <a href="{% url 'core:insc_admin' %}" class="btn btn-outline">Limpiar</a>
      {% endif %}
    </div>
  </form>

  <div class="card" style="margin-top:1rem;">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Archivo</th>
          <th>Enviado por</th>
          <th>Dirección</th>
          <th>Estado</th>
          <th>Creada</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
      {% for obj in object_list %}
        <tr>
          <td>#{{ obj.id }}</td>

          <td>
            {% if obj.file %}
              <button
                type="button"
                class="btn btn-outline btn-small js-insc-view-file"
                data-file-url="{{ obj.file.url }}"
              >
                Ver archivo
              </button>
            {% else %}
              <span style="color:#9ca3af; font-size:.85rem;">Sin archivo</span>
            {% endif %}
          </td>

          {# Enviado por: nombre + email #}
          <td>
            {{ obj.full_name }}
            {% if obj.email %}
              <br>
              <span style="color:#6b7280; font-size:.8rem;">{{ obj.email }}</span>
            {% endif %}
          </td>

          {# Dirección #}
          <td>
            {{ obj.address|default:"—" }}
          </td>

          <td>
            {% if obj.status == "PENDING" %}
              <span class="badge bg-warning text-dark">Pendiente</span>
            {% elif obj.status == "APPROVED" %}
              <span class="badge bg-success">Aprobada</span>
            {% else %}
              <span class="badge bg-danger">Rechazada</span>
            {% endif %}
          </td>

          <td>{{ obj.created_at|date:"d/m/Y H:i" }}</td>

          <td>
            <a class="btn btn-outline btn-sm" href="{% url 'core:insc_manage' obj.id %}">
              Gestionar
            </a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" style="text-align:center; color:#9ca3af;">
            Sin resultados.
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <nav class="mt-3" style="margin-top:1rem;">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET.status %}status={{request.GET.status}}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
          </li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
          </span>
        </li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% if request.GET.status %}status={{request.GET.status}}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

{# ================= POP-UP VER ARCHIVO (LISTA INSCRIPCIONES) ================= #}
<style>
  .insc-file-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1200;
  }

  .insc-file-backdrop.is-visible {
    display: flex;
  }

  .insc-file-dialog {
    background: #ffffff;
    border-radius: 22px;
    padding: 1.2rem 1.4rem;
    width: 96%;
    max-width: 1400px;
    max-height: 92vh;
    box-shadow: 0 22px 55px rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .insc-file-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .insc-file-title {
    font-size: 1rem;
    font-weight: 600;
  }

  .insc-file-close {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 0.9rem;
    color: #6b7280;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
  }

  .insc-file-close:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .insc-file-body {
    flex: 1;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    background: #111827;
    height: 70vh;       /* alto grande */
    max-height: 86vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .insc-file-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block;
  }
</style>

<div id="insc-file-backdrop" class="insc-file-backdrop">
  <div class="insc-file-dialog">
    <div class="insc-file-header">
      <div class="insc-file-title">
        Archivo de inscripción
      </div>
      <button type="button" id="insc-file-close" class="insc-file-close">
        Cerrar
      </button>
    </div>

    <div class="insc-file-body">
      <img
        id="insc-file-img"
        class="insc-file-img"
        src=""
        alt="Archivo de inscripción"
      >
    </div>
  </div>
</div>

<script>
  (function () {
    const backdrop = document.getElementById("insc-file-backdrop");
    const img      = document.getElementById("insc-file-img");
    const closeBtn = document.getElementById("insc-file-close");

    if (!backdrop || !img) return;

    // Botones "Ver archivo" de la tabla
    document.querySelectorAll(".js-insc-view-file").forEach(function (btn) {
      btn.addEventListener("click", function () {
        const url = this.getAttribute("data-file-url");
        if (!url) return;

        img.src = url;
        backdrop.classList.add("is-visible");
      });
    });

    function closePopup() {
      backdrop.classList.remove("is-visible");
      img.src = "";
    }

    if (closeBtn) {
      closeBtn.addEventListener("click", closePopup);
    }

    backdrop.addEventListener("click", function (e) {
      if (e.target === backdrop) {
        closePopup();
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && backdrop.classList.contains("is-visible")) {
        closePopup();
      }
    });
  })();
</script>
{% endblock %}
