{% extends "base.html" %}
{% block title %}Mis reservas{% endblock %}

{% block content %}
<div class="head-between" style="align-items:center; margin-bottom:1rem;">
  <h1>Mis reservas</h1>
  <a class="btn btn-primary" href="{% url 'core:reservation_create' %}">
    Nueva reserva
  </a>
</div>

<p class="text-muted" style="margin-bottom:1.5rem;">
  Aquí verás tus reservas de canchas y salón, con su estado actualizado. 
  Si tienes una reserva pendiente con cobro, podrás subir el comprobante desde la sección
  <strong>“Mis pagos”</strong>.
</p>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Recurso</th>
        <th>Vecino</th>
        <th>Título</th>
        <th>Inicio</th>
        <th>Término</th>
        <th>Estado</th>
        {% if show_cancel_reason %}
          <th>Motivo cancelación</th>
        {% endif %}
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for r in reservas %}
      <tr>
        <td>{{ r.resource }}</td>
        <td>{{ r.requested_by }}</td>
        <td>{{ r.title }}</td>
        <td>{{ r.start_at|date:"d-m-Y H:i" }}</td>
        <td>{{ r.end_at|date:"d-m-Y H:i" }}</td>

        {# Píldoras de estado #}
        <td>
          {% if r.status == "PENDING" %}
            <span class="status-pill status-pill-pending">
              {{ r.get_status_display }}
            </span>
          {% elif r.status == "APPROVED" %}
            <span class="status-pill status-pill-approved">
              {{ r.get_status_display }}
            </span>
          {% elif r.status == "CANCELLED" %}
            <span class="status-pill status-pill-cancelled">
              {{ r.get_status_display }}
            </span>
          {% else %}
            {{ r.get_status_display }}
          {% endif %}
        </td>

        {# Solo Presidente / Tesorero ven el motivo #}
        {% if show_cancel_reason %}
          <td class="small">
            {% if r.status == "CANCELLED" %}
              {% if r.cancel_reason %}
                {{ r.cancel_reason }}
              {% else %}
                Sin motivo registrado 
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
        {% endif %}

        <td class="text-right">
          {# Botón cancelar: solo el vecino que creó la reserva y si está pendiente #}
          {% if r.requested_by_id == user.id and r.status == "PENDING" %}
            <a href="{% url 'core:reservation_cancel' r.pk %}" class="btn btn-link">
              Cancelar
            </a>
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if show_cancel_reason %}8{% else %}7{% endif %}"
            class="muted"
            style="text-align:center;">
          No tienes reservas por ahora.
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{# ---------- POP-UP RESERVA CREADA ---------- #}
{% if created_reservation %}
<div id="reservation-created-modal"
     style="
       position: fixed;
       inset: 0;
       display: flex;
       align-items: center;
       justify-content: center;
       background: rgba(15, 23, 42, 0.45);
       z-index: 999;
     ">
  <div style="
        background: #ffffff;
        border-radius: 16px;
        max-width: 560px;
        width: 90%;
        padding: 24px 28px 20px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
      ">
    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">
      Reserva creada correctamente
    </h2>

    <p style="margin-bottom: 8px;">
      Tu reserva para el día 
      <strong>{{ created_reservation.date }}</strong> 
      a las 
      <strong>{{ created_reservation.time }}</strong> 
      fue registrada con éxito.
    </p>
    <p style="margin-bottom: 8px;">
      La deuda asociada a esta reserva aparecerá en tu sección 
      <strong>“Mis pagos”</strong>.
    </p>
    <p style="margin-bottom: 16px;">
      Recuerda que mientras mantengas esa deuda sin pagar, 
      <strong>no podrás crear nuevas reservas</strong>.
    </p>

    <div style="display:flex; justify-content:flex-end; margin-top: 10px;">
      <button type="button"
              id="reservation-created-close"
              class="btn btn-primary">
        Entendido
      </button>
    </div>
  </div>
</div>

<script>
  window.addEventListener('load', function () {
    var overlay = document.getElementById('reservation-created-modal');
    var btnClose = document.getElementById('reservation-created-close');
    if (!overlay) return;

    function closeModal() {
      overlay.style.display = 'none';

      // quitamos los parámetros de la URL para que no se repita el pop-up
      try {
        var url = new URL(window.location.href);
        url.searchParams.delete('created');
        url.searchParams.delete('date');
        url.searchParams.delete('time');
        window.history.replaceState({}, document.title, url.toString());
      } catch (e) {
        // fallback simple
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    if (btnClose) {
      btnClose.addEventListener('click', closeModal);
    }

    overlay.addEventListener('click', function (e) {
      if (e.target === overlay) {
        closeModal();
      }
    });
  });
</script>
{% endif %}

{% endblock %}
