{% extends "base.html" %}
{% block title %}Mis reservas{% endblock %}

{% block content %}
<div class="head-between" style="align-items:center; margin-bottom:1rem;">
  <h1>Mis reservas</h1>
  <a class="btn btn-primary" href="{% url 'core:reservation_create' %}">
    Nueva reserva
  </a>
</div>

<p class="text-muted" style="margin-bottom:1.5rem;">
  Aquí verás tus reservas de canchas y salón, con su estado actualizado. 
  Si tienes una reserva pendiente con cobro, podrás subir el comprobante desde la sección
  <strong>“Mis pagos”</strong>.
</p>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Recurso</th>
        <th>Vecino</th>
        <th>Título</th>
        <th>Inicio</th>
        <th>Término</th>
        <th>Estado</th>
        {% if show_cancel_reason %}
          <th>Motivo cancelación</th>
        {% endif %}
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for r in reservas %}
      <tr>
        <td>{{ r.resource }}</td>
        <td>{{ r.requested_by }}</td>
        <td>{{ r.title }}</td>
        <td>{{ r.start_at|date:"d-m-Y H:i" }}</td>
        <td>{{ r.end_at|date:"d-m-Y H:i" }}</td>

        {# Píldoras de estado #}
        <td>
          {% if r.status == "PENDING" %}
            <span class="status-pill status-pill-pending">
              {{ r.get_status_display }}
            </span>
          {% elif r.status == "APPROVED" %}
            <span class="status-pill status-pill-approved">
              {{ r.get_status_display }}
            </span>
          {% elif r.status == "CANCELLED" %}
            <span class="status-pill status-pill-cancelled">
              {{ r.get_status_display }}
            </span>
          {% else %}
            {{ r.get_status_display }}
          {% endif %}
        </td>

        {# Solo Presidente / Tesorero ven el motivo #}
        {% if show_cancel_reason %}
          <td class="small">
            {% if r.status == "CANCELLED" %}
              {% if r.cancel_reason %}
                {{ r.cancel_reason }}
              {% else %}
                Sin motivo registrado 
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
        {% endif %}

        <td class="text-right">
          {# Botón cancelar: solo el vecino que creó la reserva y si está pendiente #}
          {% if r.requested_by_id == user.id and r.status == "PENDING" %}
            <a href="{% url 'core:reservation_cancel' r.pk %}" class="btn btn-link">
              Cancelar
            </a>
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if show_cancel_reason %}8{% else %}7{% endif %}"
            class="muted"
            style="text-align:center;">
          No tienes reservas por ahora.
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
